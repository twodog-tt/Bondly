.PHONY: build run test clean deps lint docker-build docker-run dev-build dev-up dev-down dev-logs restart-api api-status api-logs stop-api start-api

# æ„å»ºå˜é‡
BINARY_NAME=bondly-api
BUILD_DIR=build
DOCKER_IMAGE=bondly-api

# æ„å»ºåº”ç”¨
build:
	@echo "Building $(BINARY_NAME)..."
	@mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/$(BINARY_NAME) ./main.go

# å¼€å‘ç¯å¢ƒæ„å»ºï¼ˆé€‚ç”¨äº Dockerï¼‰
dev-build:
	@echo "Building for development environment..."
	GOOS=linux GOARCH=amd64 go build -o bondly-api main.go
	@echo "Binary built for Linux container"

# è¿è¡Œåº”ç”¨
run:
	@echo "Running $(BINARY_NAME)..."
	go run ./main.go

# å®‰è£…ä¾èµ–
deps:
	@echo "Installing dependencies..."
	go mod download
	go mod tidy

# è¿è¡Œæµ‹è¯•
test:
	@echo "Running tests..."
	go test -v ./...

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-coverage:
	@echo "Running tests with coverage..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "Formatting code..."
	go fmt ./...

# ä»£ç æ£€æŸ¥
lint:
	@echo "Linting code..."
	golangci-lint run

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "Cleaning build files..."
	rm -rf $(BUILD_DIR)
	rm -f coverage.out coverage.html

# Docker æ„å»º
docker-build:
	@echo "Building Docker image..."
	docker build -t $(DOCKER_IMAGE) .

# Docker è¿è¡Œ
docker-run:
	@echo "Running Docker container..."
	docker run -p 8080:8080 --env-file .env $(DOCKER_IMAGE)

# å¼€å‘ç¯å¢ƒå¯åŠ¨
dev-up:
	@echo "Starting development environment..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "Development environment started"

# å¼€å‘ç¯å¢ƒåœæ­¢
dev-down:
	@echo "Stopping development environment..."
	docker-compose -f docker-compose.dev.yml down
	@echo "Development environment stopped"

# æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—
dev-logs:
	@echo "Showing bondly-api logs..."
	docker logs bondly-api

# é‡å¯ bondly-api æœåŠ¡
restart-api:
	@echo "Restarting bondly-api service..."
	docker-compose -f docker-compose.dev.yml restart bondly-api
	@echo "âœ… bondly-api service restarted successfully"

# æŸ¥çœ‹ bondly-api æœåŠ¡çŠ¶æ€
api-status:
	@echo "Checking bondly-api service status..."
	docker-compose -f docker-compose.dev.yml ps bondly-api

# æŸ¥çœ‹ bondly-api å®æ—¶æ—¥å¿—
api-logs:
	@echo "Following bondly-api logs (Press Ctrl+C to exit)..."
	docker-compose -f docker-compose.dev.yml logs -f bondly-api

# æŸ¥çœ‹æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼ˆå®¿ä¸»æœºï¼‰
logs-info:
	@echo "Following info logs (Press Ctrl+C to exit)..."
	tail -f logs/info.log

# æŸ¥çœ‹æœ¬åœ°é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼ˆå®¿ä¸»æœºï¼‰
logs-error:
	@echo "Following error logs (Press Ctrl+C to exit)..."
	tail -f logs/error.log

# ç›‘æ§APIæœåŠ¡æ—¥å¿—ï¼ˆæ™ºèƒ½é€‰æ‹©ï¼‰
logs-tail:
	@echo "Monitoring API service logs (Press Ctrl+C to exit)..."
	@if docker-compose -f docker-compose.dev.yml ps bondly-api | grep -q "Up"; then \
		echo "ğŸ“¦ API service running in Docker - using container logs..."; \
		docker-compose -f docker-compose.dev.yml logs -f bondly-api; \
	elif [ -f "logs/info.log" ]; then \
		echo "ğŸ“„ Using local log file: logs/info.log"; \
		tail -f logs/info.log; \
	elif [ -f "logs/app.log" ]; then \
		echo "ğŸ“„ Using local log file: logs/app.log"; \
		tail -f logs/app.log; \
	elif [ -f "app.log" ]; then \
		echo "ğŸ“„ Using local log file: app.log"; \
		tail -f app.log; \
	else \
		echo "âŒ No log source found. Available options:"; \
		echo "   - Start Docker service: make dev-up"; \
		echo "   - Use 'make api-logs' for Docker container logs"; \
		echo "   - Use 'make logs-info' for local file logs"; \
		exit 1; \
	fi

# åœæ­¢ bondly-api æœåŠ¡
stop-api:
	@echo "Stopping bondly-api service..."
	docker-compose -f docker-compose.dev.yml stop bondly-api
	@echo "âœ… bondly-api service stopped"

# å¯åŠ¨ bondly-api æœåŠ¡
start-api:
	@echo "Starting bondly-api service..."
	docker-compose -f docker-compose.dev.yml start bondly-api
	@echo "âœ… bondly-api service started"

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨å¼€å‘ç¯å¢ƒ
dev-rebuild:
	@echo "Rebuilding and starting development environment..."
	$(MAKE) dev-build
	docker-compose -f docker-compose.dev.yml build --no-cache
	docker-compose -f docker-compose.dev.yml up -d
	@echo "Development environment rebuilt and started"

# å¼€å‘æ¨¡å¼è¿è¡Œ
dev:
	@echo "Running in development mode..."
	go run main.go

# ç”Ÿæˆ API æ–‡æ¡£
docs:
	@echo "Generating API documentation..."
	swag init -g main.go --parseDependency --parseInternal

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "Running database migrations..."
	go run ./cmd/migrate/main.go

# æ•°æ®å¡«å……
seed:
	@echo "Seeding database with sample data..."
	go run ./cmd/seed-data/main.go

# Redisç”¨æˆ·ä¿¡æ¯æ¸…é™¤
redis-clear-users:
	@echo "æ¸…é™¤Redisä¸­çš„ç”¨æˆ·ä¿¡æ¯..."
	@./scripts/clear-redis-users.sh --docker --all-users

# Redisç”¨æˆ·ä¿¡æ¯æ¸…é™¤ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰
redis-clear-users-dry-run:
	@echo "é¢„è§ˆRedisä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å®é™…åˆ é™¤ï¼‰..."
	@./scripts/clear-redis-users.sh --docker --all-users --dry-run

# æ¸…é™¤Redisä¼šè¯ç¼“å­˜
redis-clear-sessions:
	@echo "æ¸…é™¤Redisä¸­çš„ä¼šè¯ç¼“å­˜..."
	@./scripts/clear-redis-users.sh --docker --sessions

# æ¸…é™¤Redisä»¤ç‰Œç¼“å­˜
redis-clear-tokens:
	@echo "æ¸…é™¤Redisä¸­çš„ä»¤ç‰Œç¼“å­˜..."
	@./scripts/clear-redis-users.sh --docker --tokens

# æ¸…é™¤Redisç”¨æˆ·æ•°æ®ç¼“å­˜
redis-clear-user-data:
	@echo "æ¸…é™¤Redisä¸­çš„ç”¨æˆ·æ•°æ®ç¼“å­˜..."
	@./scripts/clear-redis-users.sh --docker --user-data

# æ˜¾ç¤ºRedisç¼“å­˜çŠ¶æ€
redis-status:
	@echo "æ˜¾ç¤ºRedisç¼“å­˜çŠ¶æ€..."
	@./scripts/clear-redis-users.sh --docker --dry-run --all-users

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "Available commands:"
	@echo ""
	@echo "Development Environment (æ¨è):"
	@echo "  dev-build    - Build binary for Linux container"
	@echo "  dev-up       - Start development environment"
	@echo "  dev-down     - Stop development environment"
	@echo "  dev-logs     - Show bondly-api logs"
	@echo "  dev-rebuild  - Rebuild and start dev environment"
	@echo ""
	@echo "API Service Management:"
	@echo "  restart-api  - Restart bondly-api service only"
	@echo "  start-api    - Start bondly-api service"
	@echo "  stop-api     - Stop bondly-api service"
	@echo "  api-status   - Check bondly-api service status"
	@echo "  api-logs     - Follow bondly-api real-time logs (Dockerå®¹å™¨)"
	@echo "  logs-info    - Follow local info logs (æœ¬åœ°æ–‡ä»¶)"
	@echo "  logs-error   - Follow local error logs (æœ¬åœ°æ–‡ä»¶)"
	@echo "  logs-tail    - Smart log monitoring (è‡ªåŠ¨é€‰æ‹©Dockeræˆ–æœ¬åœ°)"
	@echo ""
	@echo "Local Development:"
	@echo "  build        - Build the application"
	@echo "  run          - Run the application"
	@echo "  dev          - Run in development mode"
	@echo ""
	@echo "Docker:"
	@echo "  docker-build - Build Docker image"
	@echo "  docker-run   - Run Docker container"
	@echo ""
	@echo "Code Quality:"
	@echo "  fmt          - Format code"
	@echo "  lint         - Lint code"
	@echo "  test         - Run tests"
	@echo "  test-coverage- Run tests with coverage"
	@echo ""
	@echo "Database:"
	@echo "  migrate      - Run database migrations"
	@echo "  seed         - Seed database with sample data"
	@echo ""
	@echo "Redis Management:"
	@echo "  redis-clear-users        - æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³ç¼“å­˜"
	@echo "  redis-clear-users-dry-run- é¢„è§ˆç”¨æˆ·ç¼“å­˜ï¼ˆä¸åˆ é™¤ï¼‰"
	@echo "  redis-clear-sessions     - æ¸…é™¤ä¼šè¯ç¼“å­˜"
	@echo "  redis-clear-tokens       - æ¸…é™¤ä»¤ç‰Œç¼“å­˜"
	@echo "  redis-clear-user-data    - æ¸…é™¤ç”¨æˆ·æ•°æ®ç¼“å­˜"
	@echo "  redis-status             - æ˜¾ç¤ºRedisç¼“å­˜çŠ¶æ€"
	@echo ""
	@echo "Utilities:"
	@echo "  deps         - Install dependencies"
	@echo "  clean        - Clean build files"
	@echo "  docs         - Generate API documentation"
	@echo "  help         - Show this help"
	@echo ""
	@echo "Architecture:"
	@echo "  Handlers â†’ Services â†’ Repositories â†’ Database"
	@echo "  Use 'make dev-rebuild' after code changes" 